{% extends "base.html" %}

{% block title %}Settings - Chat Online{% endblock %}

{% block content %}
<div class="content-page-container">
    <div class="content-page-header">
        <h1><i class="fas fa-cog"></i> Settings</h1>
        <p>Manage your account preferences</p>
    </div>

    <!-- Auth Required -->
    <div id="auth-required" class="auth-required" style="display: none; padding: var(--space-12);">
        <i class="fas fa-lock" style="font-size: 64px; color: var(--primary); margin-bottom: var(--space-4);"></i>
        <h3>Login Required</h3>
        <p>Please login to access settings</p>
        <a href="/login" class="btn"><i class="fas fa-sign-in-alt"></i> Login</a>
        <p style="margin-top: var(--space-3); font-size: var(--text-sm);">Don't have an account?</p>
        <a href="/register" class="btn" style="background: var(--bg-100); color: var(--bg-700);"><i class="fas fa-user-plus"></i> Register</a>
    </div>

    <!-- Settings Content -->
    <div id="settings-content" style="display: none;">
        <div class="settings-grid">
            <div class="settings-section">
                <h3><i class="fas fa-user"></i> Profile Settings</h3>
                <div class="setting-item">
                    <label>Username</label>
                    <input type="text" id="setting-username" disabled>
                </div>
                <div class="setting-item">
                    <label>Email</label>
                    <input type="email" id="setting-email" disabled>
                </div>
                <div class="setting-item">
                    <label>Age</label>
                    <select id="setting-age">
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Gender</label>
                    <select id="setting-gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Country</label>
                    <select id="setting-country">
                        <option value="US">United States</option>
                        <option value="GB">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="ES">Spain</option>
                        <option value="IT">Italy</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                        <option value="IN">India</option>
                        <option value="PK">Pakistan</option>
                        <option value="BD">Bangladesh</option>
                        <option value="NG">Nigeria</option>
                        <option value="ZA">South Africa</option>
                        <option value="AE">UAE</option>
                        <option value="SA">Saudi Arabia</option>
                        <option value="SG">Singapore</option>
                        <option value="MY">Malaysia</option>
                        <option value="PH">Philippines</option>
                        <option value="ID">Indonesia</option>
                        <option value="TH">Thailand</option>
                        <option value="VN">Vietnam</option>
                        <option value="RU">Russia</option>
                        <option value="UA">Ukraine</option>
                        <option value="PL">Poland</option>
                        <option value="NL">Netherlands</option>
                        <option value="BE">Belgium</option>
                        <option value="SE">Sweden</option>
                        <option value="NO">Norway</option>
                        <option value="DK">Denmark</option>
                        <option value="FI">Finland</option>
                        <option value="CH">Switzerland</option>
                        <option value="AT">Austria</option>
                        <option value="IE">Ireland</option>
                        <option value="NZ">New Zealand</option>
                        <option value="IL">Israel</option>
                        <option value="TR">Turkey</option>
                        <option value="GR">Greece</option>
                        <option value="PT">Portugal</option>
                        <option value="CZ">Czech Republic</option>
                        <option value="HU">Hungary</option>
                        <option value="RO">Romania</option>
                        <option value="AR">Argentina</option>
                        <option value="CL">Chile</option>
                        <option value="CO">Colombia</option>
                        <option value="PE">Peru</option>
                        <option value="EG">Egypt</option>
                        <option value="MA">Morocco</option>
                        <option value="KE">Kenya</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="saveProfile()" style="margin-top: var(--space-4);">
                    <i class="fas fa-save"></i> Save Profile
                </button>
            </div>

            <div class="settings-section">
                <h3><i class="fas fa-bell"></i> Notifications</h3>
                <div class="setting-toggle">
                    <span>Message Notifications</span>
                    <label class="toggle">
                        <input type="checkbox" id="notif-messages" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-toggle">
                    <span>Friend Request Notifications</span>
                    <label class="toggle">
                        <input type="checkbox" id="notif-friends" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-toggle">
                    <span>Sound Effects</span>
                    <label class="toggle">
                        <input type="checkbox" id="notif-sound">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h3><i class="fas fa-shield-alt"></i> Privacy</h3>
                <div class="setting-toggle">
                    <span>Show Online Status</span>
                    <label class="toggle">
                        <input type="checkbox" id="privacy-online" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-toggle">
                    <span>Allow Friend Requests</span>
                    <label class="toggle">
                        <input type="checkbox" id="privacy-requests" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h3><i class="fas fa-sign-out-alt"></i> Account</h3>
                <button class="btn btn-secondary" onclick="logout()" style="width: 100%; margin-bottom: var(--space-3);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button class="btn btn-danger" onclick="deleteAccount()" style="width: 100%;">
                    <i class="fas fa-trash"></i> Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.content-page-container { max-width: 1200px; margin: 0 auto; padding: var(--space-6); }
.content-page-header { text-align: center; margin-bottom: var(--space-8); }
.content-page-header h1 { font-size: var(--text-2xl); color: var(--bg-800); display: flex; align-items: center; justify-content: center; gap: var(--space-3); margin-bottom: var(--space-2); }
.content-page-header h1 i { color: var(--primary); }
.content-page-header p { color: var(--bg-500); }
.settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: var(--space-6); max-width: 1200px; margin: 0 auto; }
.settings-section { background: var(--white); border-radius: var(--radius-xl); padding: var(--space-6); box-shadow: var(--shadow-md); }
.settings-section h3 { font-size: var(--text-lg); color: var(--bg-800); margin-bottom: var(--space-4); padding-bottom: var(--space-3); border-bottom: 1px solid var(--bg-200); display: flex; align-items: center; gap: var(--space-2); }
.settings-section h3 i { color: var(--primary); }
.setting-item { margin-bottom: var(--space-4); }
.setting-item label { display: block; font-size: var(--text-sm); color: var(--bg-600); margin-bottom: var(--space-2); }
.setting-item input, .setting-item select { width: 100%; padding: var(--space-3); border: 2px solid var(--bg-200); border-radius: var(--radius-lg); font-size: var(--text-base); transition: all var(--transition-base); }
.setting-item input:focus, .setting-item select:focus { outline: none; border-color: var(--primary); }
.setting-toggle { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3) 0; border-bottom: 1px solid var(--bg-100); }
.setting-toggle:last-child { border-bottom: none; }
.setting-toggle span { color: var(--bg-700); }
.toggle { position: relative; width: 50px; height: 26px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-300); border-radius: 26px; transition: var(--transition-base); }
.slider::before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: var(--transition-base); }
.toggle input:checked + .slider { background: var(--primary); }
.toggle input:checked + .slider::before { transform: translateX(24px); }
.btn { padding: var(--space-3) var(--space-6); border: none; border-radius: var(--radius-xl); font-weight: var(--font-semibold); cursor: pointer; transition: all var(--transition-base); display: inline-flex; align-items: center; gap: var(--space-2); }
.btn-primary { background: var(--gradient); color: var(--white); }
.btn-secondary { background: var(--bg-100); color: var(--bg-700); }
.btn-danger { background: #EF4444; color: var(--white); }
.btn:hover { transform: scale(1.02); }
.auth-required { display: flex; flex-direction: column; align-items: center; text-align: center; }
.auth-required .btn { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-3) var(--space-6); background: var(--gradient); color: var(--white); border: none; border-radius: var(--radius-xl); font-weight: var(--font-semibold); cursor: pointer; text-decoration: none; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('auth_token');
    if (!token || !localStorage.getItem('user_data')) {
        document.getElementById('auth-required').style.display = 'flex';
        return;
    }
    loadSettings();
});

function loadSettings() {
    const token = localStorage.getItem('auth_token');

    fetch('/api/auth/me', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        showLoading: false
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const user = data.data;
            document.getElementById('settings-content').style.display = 'block';
            document.getElementById('setting-username').value = user.username || '';
            document.getElementById('setting-email').value = user.email || '';
            document.getElementById('setting-age').value = user.age || 18;
            document.getElementById('setting-gender').value = user.gender || 'other';
            document.getElementById('setting-country').value = user.country || 'US';
        }
    })
    .catch(() => {
        // Try to load from localStorage
        try {
            const user = JSON.parse(localStorage.getItem('user_data') || '{}');
            if (user.username) {
                document.getElementById('settings-content').style.display = 'block';
                document.getElementById('setting-username').value = user.username || '';
                document.getElementById('setting-email').value = user.email || '';
                document.getElementById('setting-age').value = user.age || 18;
                document.getElementById('setting-gender').value = user.gender || 'other';
                document.getElementById('setting-country').value = user.country || 'US';
            }
        } catch (e) {
            alert('Failed to load settings');
        }
    });
}

function saveProfile() {
    const age = document.getElementById('setting-age').value;
    const gender = document.getElementById('setting-gender').value;
    const country = document.getElementById('setting-country').value;

    // Store in localStorage for now (would need API endpoint to update)
    try {
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        userData.age = age;
        userData.gender = gender;
        userData.country = country;
        localStorage.setItem('user_data', JSON.stringify(userData));
        alert('Profile saved!');
    } catch (e) {
        alert('Failed to save profile');
    }
}

function logout() {
    const token = localStorage.getItem('auth_token');
    
    fetch('/api/auth/logout', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .finally(() => {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_data');
        window.location.href = '/';
    });
}

function deleteAccount() {
    if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        alert('Account deletion is not available yet. Please contact support.');
    }
}
</script>
{% endblock %}
