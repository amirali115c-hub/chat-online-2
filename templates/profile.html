{% extends "base.html" %}

{% block title %}Profile - Chat Online{% endblock %}

{% block extra_css %}
<style>
.profile-page-container { max-width: 800px; margin: 0 auto; padding: var(--space-6); }
.profile-card { background: var(--white); border-radius: var(--radius-xl); padding: var(--space-6); margin-bottom: var(--space-6); position: relative; }
.profile-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient); border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
.profile-header { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-6); }
.profile-avatar-large { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.profile-avatar-large.male { background: linear-gradient(135deg, #0EA5E9, #06B6D4); }
.profile-avatar-large.female { background: linear-gradient(135deg, #EC4899, #F472B6); }
.profile-avatar-large.other { background: linear-gradient(135deg, #8B5CF6, #A78BFA); }
.profile-avatar-large i { color: var(--white); font-size: var(--text-2xl); }
.profile-details h2 { font-size: var(--text-xl); color: var(--bg-800); margin-bottom: var(--space-1); }
.profile-details p { font-size: var(--text-sm); color: var(--bg-500); }
.profile-badges { display: flex; gap: var(--space-2); margin-top: var(--space-3); }
.badge { padding: var(--space-1) var(--space-3); border-radius: var(--radius-lg); font-size: var(--text-xs); font-weight: var(--font-semibold); display: inline-flex; align-items: center; gap: var(--space-1); }
.badge-online { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.badge-guest { background: rgba(139, 92, 246, 0.1); color: var(--primary); }
.profile-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-4); margin-bottom: var(--space-6); padding: var(--space-4); background: var(--bg-50); border-radius: var(--radius-xl); }
.stat-box { text-align: center; }
.stat-num { font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--bg-800); display: block; }
.stat-label { font-size: var(--text-sm); color: var(--bg-500); display: flex; align-items: center; justify-content: center; gap: var(--space-1); }
.stat-label i { color: var(--primary); }
.profile-actions { display: flex; gap: var(--space-3); justify-content: center; }
.profile-sections { display: flex; flex-direction: column; gap: var(--space-6); }
.profile-section-card { background: var(--white); border-radius: var(--radius-xl); padding: var(--space-6); position: relative; }
.profile-section-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient); border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
.profile-section-card h3 { font-size: var(--text-lg); color: var(--bg-800); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2); }
.profile-section-card h3 i { color: var(--primary); }
.empty-state { text-align: center; padding: var(--space-8); color: var(--bg-500); }
.empty-state i { font-size: 32px; color: var(--bg-300); margin-bottom: var(--space-2); display: block; }
/* Auth required */
.auth-required { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: var(--space-12); }
.auth-required i { font-size: 64px; color: var(--primary); margin-bottom: var(--space-4); }
.auth-required h3 { font-size: var(--text-xl); color: var(--bg-800); margin-bottom: var(--space-2); }
.auth-required p { color: var(--bg-500); margin-bottom: var(--space-4); }
.auth-required .btn { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-3) var(--space-6); background: var(--gradient); color: var(--white); border: none; border-radius: var(--radius-xl); font-weight: var(--font-semibold); cursor: pointer; text-decoration: none; }
</style>
{% endblock %}

{% block content %}
<div class="profile-page-container">
    <!-- Auth Required -->
    <div id="auth-required" class="auth-required" style="display: none;">
        <i class="fas fa-lock"></i>
        <h3>Login Required</h3>
        <p>Please login to view your profile</p>
        <a href="/login" class="btn"><i class="fas fa-sign-in-alt"></i> Login</a>
        <p style="margin-top: var(--space-3); font-size: var(--text-sm);">Don't have an account?</p>
        <a href="/register" class="btn" style="background: var(--bg-100); color: var(--bg-700);"><i class="fas fa-user-plus"></i> Register</a>
    </div>

    <!-- Profile Content -->
    <div id="profile-content" style="display: none;">
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar-large" id="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-details">
                    <h2 id="profile-username">Username</h2>
                    <p id="profile-info"><span id="profile-age">--</span> | <span id="profile-gender">--</span> | <span id="profile-country">--</span></p>
                    <div class="profile-badges">
                        <span class="badge badge-online"><i class="fas fa-circle"></i> Online</span>
                        <span class="badge badge-guest"><i class="fas fa-user"></i> <span id="profile-status">Member</span></span>
                    </div>
                </div>
            </div>
            <div class="profile-stats">
                <div class="stat-box">
                    <span class="stat-num" id="friends-count">0</span>
                    <span class="stat-label"><i class="fas fa-heart"></i> Friends</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="messages-count">0</span>
                    <span class="stat-label"><i class="fas fa-comment"></i> Messages</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="chats-count">0</span>
                    <span class="stat-label"><i class="fas fa-comments"></i> Chats</span>
                </div>
            </div>
            <div class="profile-actions">
                <a href="/settings" class="btn btn-secondary"><i class="fas fa-cog"></i> Settings</a>
                <a href="/friends" class="btn btn-primary"><i class="fas fa-user-plus"></i> Friends</a>
            </div>
        </div>

        <div class="profile-sections">
            <div class="profile-section-card">
                <h3><i class="fas fa-user-friends"></i> Friends</h3>
                <div id="friends-list" class="empty-state">
                    <i class="fas fa-user-friends"></i>
                    <p>Loading friends...</p>
                </div>
            </div>
            <div class="profile-section-card">
                <h3><i class="fas fa-history"></i> Recent Activity</h3>
                <div id="activity-list" class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>No recent activity</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('auth_token');
    const userData = localStorage.getItem('user_data');

    if (!token || !userData) {
        document.getElementById('auth-required').style.display = 'flex';
        return;
    }

    loadProfile();
});

function loadProfile() {
    const token = localStorage.getItem('auth_token');

    // Fetch current user data
    fetch('/api/auth/me', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        showLoading: false
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const user = data.data;
            displayProfile(user);
            loadFriends();
            loadStats();
        } else {
            // Token invalid, clear storage
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            document.getElementById('auth-required').style.display = 'flex';
        }
    })
    .catch(() => {
        // Try to use stored user data
        try {
            const user = JSON.parse(localStorage.getItem('user_data') || '{}');
            displayProfile(user);
            loadFriends();
            loadStats();
        } catch (e) {
            document.getElementById('auth-required').style.display = 'flex';
        }
    });
}

function displayProfile(user) {
    document.getElementById('profile-content').style.display = 'block';

    document.getElementById('profile-username').textContent = user.username || 'Unknown';
    document.getElementById('profile-age').textContent = user.age || '--';
    document.getElementById('profile-country').textContent = user.country || '--';

    const gender = user.gender || 'other';
    const genderEl = document.getElementById('profile-gender');
    const genderIcon = gender === 'male' ? '<i class="fas fa-male"></i> Male' :
                       gender === 'female' ? '<i class="fas fa-female"></i> Female' : 'Other';
    genderEl.innerHTML = genderIcon;

    const avatar = document.getElementById('profile-avatar');
    avatar.className = 'profile-avatar-large ' + gender.toLowerCase();

    const status = document.getElementById('profile-status');
    status.textContent = user.is_verified ? 'Verified' : 'Member';
}

function loadFriends() {
    const token = localStorage.getItem('auth_token');
    const list = document.getElementById('friends-list');

    fetch('/api/friends', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        showLoading: false
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.data) {
            const friends = data.data;
            document.getElementById('friends-count').textContent = friends.length;

            if (friends.length === 0) {
                list.innerHTML = '<i class="fas fa-user-friends"></i><p>No friends yet. Start chatting to make new friends!</p>';
                return;
            }

            list.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: var(--space-2); justify-content: center;">' +
                friends.slice(0, 10).map(f => {
                    const gender = (f.gender || 'other').toLowerCase();
                    return '<span style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-3); background: var(--bg-100); border-radius: var(--radius-lg);"><div class="profile-avatar-large" style="width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;' + (gender === 'male' ? 'background: linear-gradient(135deg, #0EA5E9, #06B6D4);' : gender === 'female' ? 'background: linear-gradient(135deg, #EC4899, #F472B6);' : 'background: linear-gradient(135deg, #8B5CF6, #A78BFA);') + '"><i class="fas fa-user" style="color: white; font-size: 10px;"></i></div>' + escapeHtml(f.username) + '</span>';
                }).join('') + '</div>' + (friends.length > 10 ? '<p style="margin-top: var(--space-2); color: var(--bg-500);">And ' + (friends.length - 10) + ' more...</p>' : '');
        } else {
            list.innerHTML = '<i class="fas fa-user-friends"></i><p>No friends yet</p>';
        }
    })
    .catch(() => {
        list.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Failed to load friends</p>';
    });
}

function loadStats() {
    const token = localStorage.getItem('auth_token');

    fetch('/api/messages?type=received', {
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        showLoading: false
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.data) {
            document.getElementById('messages-count').textContent = data.data.length;
        }
    });

    // Mock chat count for now
    document.getElementById('chats-count').textContent = '0';
}

function escapeHtml(t) {
    if (!t) return '';
    const div = document.createElement('div');
    div.textContent = t;
    return div.innerHTML;
}
</script>
{% endblock %}
