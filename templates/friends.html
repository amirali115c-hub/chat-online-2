{% extends "base.html" %}

{% block title %}Friends - Chat Online{% endblock %}

{% block content %}
<div class="content-page-container">
    <div class="content-page-header">
        <h1><i class="fas fa-comment-dots"></i> Friends</h1>
        <p>Your friends list</p>
    </div>

    <!-- Auth Required -->
    <div id="auth-required" class="auth-required" style="display: none; padding: var(--space-12);">
        <i class="fas fa-lock" style="font-size: 64px; color: var(--primary); margin-bottom: var(--space-4);"></i>
        <h3>Login Required</h3>
        <p>Please login to view your friends</p>
        <a href="/login" class="btn"><i class="fas fa-sign-in-alt"></i> Login</a>
        <p style="margin-top: var(--space-3); font-size: var(--text-sm);">Don't have an account?</p>
        <a href="/register" class="btn" style="background: var(--bg-100); color: var(--bg-700);"><i class="fas fa-user-plus"></i> Register</a>
    </div>

    <!-- Loading -->
    <div id="loading-state" class="loading-state" style="display: none; padding: var(--space-12);">
        <i class="fas fa-spinner" style="font-size: 32px; color: var(--primary); animation: spin 1s linear infinite;"></i>
        <p>Loading friends...</p>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="empty-state" style="display: none; padding: var(--space-12);">
        <i class="fas fa-user-friends" style="font-size: 48px; color: var(--bg-300); margin-bottom: var(--space-3);"></i>
        <h3>No friends yet</h3>
        <p>Start chatting to make new friends!</p>
    </div>

    <!-- Friends Content -->
    <div id="friends-content" style="display: none;">
        <div class="friends-tabs">
            <button class="friend-tab active" onclick="switchTab('friends')">All Friends (<span id="friends-count">0</span>)</button>
            <button class="friend-tab" onclick="switchTab('requests')">Pending Requests (<span id="requests-count">0</span>)</button>
        </div>
        <div class="friends-grid" id="friends-grid">
            <!-- Friends populated by JS -->
        </div>
    </div>
</div>

<style>
.friends-tabs { display: flex; gap: var(--space-4); justify-content: center; margin-bottom: var(--space-8); }
.friend-tab { padding: var(--space-3) var(--space-6); background: var(--bg-50); border: 2px solid var(--bg-200); border-radius: var(--radius-xl); cursor: pointer; font-weight: var(--font-semibold); color: var(--bg-600); transition: all var(--transition-base); }
.friend-tab.active { background: var(--gradient); color: var(--white); border-color: transparent; }
.friends-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-6); max-width: 1000px; margin: 0 auto; }
.friend-card { background: var(--white); border-radius: var(--radius-xl); padding: var(--space-6); text-align: center; box-shadow: var(--shadow-md); transition: all var(--transition-base); }
.friend-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
.friend-avatar { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-4); position: relative; }
.friend-avatar.male { background: linear-gradient(135deg, #0EA5E9, #06B6D4); }
.friend-avatar.female { background: linear-gradient(135deg, #EC4899, #F472B6); }
.friend-avatar.other { background: linear-gradient(135deg, #8B5CF6, #A78BFA); }
.friend-avatar i { color: var(--white); font-size: var(--text-2xl); }
.friend-avatar .online-dot { position: absolute; bottom: 4px; right: 4px; width: 16px; height: 16px; background: var(--success); border-radius: 50%; border: 3px solid var(--white); }
.friend-card h4 { font-size: var(--text-base); color: var(--bg-800); margin-bottom: var(--space-1); }
.friend-card p { font-size: var(--text-sm); color: var(--bg-500); margin-bottom: var(--space-4); }
.friend-card .btn { padding: var(--space-2) var(--space-4); font-size: var(--text-sm); }
.btn-sm { padding: var(--space-2) var(--space-4); font-size: var(--text-sm); }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.auth-required { display: flex; flex-direction: column; align-items: center; text-align: center; }
.auth-required .btn { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-3) var(--space-6); background: var(--gradient); color: var(--white); border: none; border-radius: var(--radius-xl); font-weight: var(--font-semibold); cursor: pointer; text-decoration: none; }
</style>

{% endblock %}

{% block extra_js %}
<script>
let currentTab = 'friends';
let friends = [];
let requests = [];

document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('auth_token');
    if (!token || !localStorage.getItem('user_data')) {
        document.getElementById('auth-required').style.display = 'flex';
        return;
    }
    loadFriends();
});

function loadFriends() {
    const token = localStorage.getItem('auth_token');
    document.getElementById('loading-state').style.display = 'flex';
    document.getElementById('friends-content').style.display = 'none';

    Promise.all([
        fetch('/api/friends', { headers: { 'Authorization': 'Bearer ' + token } }).then(r => r.json()),
        fetch('/api/friends/requests', { headers: { 'Authorization': 'Bearer ' + token } }).then(r => r.json())
    ])
    .then(([friendsData, requestsData]) => {
        document.getElementById('loading-state').style.display = 'none';
        friends = friendsData.success ? friendsData.data || [] : [];
        requests = requestsData.success ? requestsData.data || [] : [];
        renderFriends();
    })
    .catch(() => {
        document.getElementById('loading-state').style.display = 'none';
        showError('Failed to load friends');
    });
}

function renderFriends() {
    const content = document.getElementById('friends-content');
    const empty = document.getElementById('empty-state');
    const grid = document.getElementById('friends-grid');
    const friendsCount = document.getElementById('friends-count');
    const requestsCount = document.getElementById('requests-count');

    friendsCount.textContent = friends.length;
    requestsCount.textContent = requests.length;

    const items = currentTab === 'friends' ? friends : requests;

    if (items.length === 0) {
        content.style.display = 'none';
        empty.style.display = 'flex';
        empty.querySelector('h3').textContent = currentTab === 'friends' ? 'No friends yet' : 'No pending requests';
        empty.querySelector('p').textContent = currentTab === 'friends' ? 'Start chatting to make new friends!' : 'When you receive friend requests, they\'ll appear here';
        return;
    }

    empty.style.display = 'none';
    content.style.display = 'block';
    grid.innerHTML = '';

    items.forEach(friend => {
        const card = document.createElement('div');
        card.className = 'friend-card';
        const gender = (friend.gender || 'other').toLowerCase();
        const username = friend.username || 'Unknown';
        const isOnline = friend.is_online;

        if (currentTab === 'friends') {
            card.innerHTML = `
                <div class="friend-avatar ${gender}">
                    <i class="fas fa-user"></i>
                    ${isOnline ? '<span class="online-dot"></span>' : ''}
                </div>
                <h4>${escapeHtml(username)}</h4>
                <p>${isOnline ? 'Online' : 'Offline'}</p>
                <button class="btn btn-primary btn-sm" onclick="startChat('${escapeHtml(username)}')"><i class="fas fa-comment"></i> Chat</button>
            `;
        } else {
            card.innerHTML = `
                <div class="friend-avatar ${gender}">
                    <i class="fas fa-user"></i>
                </div>
                <h4>${escapeHtml(username)}</h4>
                <p>Pending request</p>
                <div style="display: flex; gap: var(--space-2); justify-content: center;">
                    <button class="btn btn-primary btn-sm" onclick="acceptRequest('${friend.request_id || friend.id}')"><i class="fas fa-check"></i></button>
                    <button class="btn btn-secondary btn-sm" onclick="rejectRequest('${friend.request_id || friend.id}')"><i class="fas fa-times"></i></button>
                </div>
            `;
        }
        grid.appendChild(card);
    });
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.friend-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    renderFriends();
}

function acceptRequest(requestId) {
    const token = localStorage.getItem('auth_token');
    fetch('/api/friends/request/accept', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: requestId }),
        showLoading: true
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            requests = requests.filter(r => (r.request_id || r.id) !== requestId);
            loadFriends();
        } else {
            alert(data.error?.message || 'Failed to accept request');
        }
    })
    .catch(() => alert('Failed to accept request'));
}

function rejectRequest(requestId) {
    const token = localStorage.getItem('auth_token');
    fetch('/api/friends/request/reject', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: requestId }),
        showLoading: true
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            requests = requests.filter(r => (r.request_id || r.id) !== requestId);
            renderFriends();
        }
    });
}

function startChat(username) {
    window.location.href = '/chat/1on1?user=' + encodeURIComponent(username);
}

function showError(msg) {
    document.getElementById('empty-state').style.display = 'flex';
    document.getElementById('empty-state').innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--primary); margin-bottom: var(--space-3);"></i><h3>Error</h3><p>' + escapeHtml(msg) + '</p>';
}

function escapeHtml(t) {
    if (!t) return '';
    const div = document.createElement('div');
    div.textContent = t;
    return div.innerHTML;
}

window.switchTab = switchTab;
</script>
{% endblock %}
