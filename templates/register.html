{% extends "base.html" %}

{% block title %}Registration - Chat Online{% endblock %}

{% block content %}
<div class="auth-page-container">
    <div class="auth-card register-card">
        <div class="auth-header">
            <div class="logo-section">
                <i class="fas fa-comments"></i>
            </div>
            <h1>Create Account</h1>
            <p>Join Chat Online today</p>
        </div>

        <form id="register-form" class="auth-form-full">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Username</label>
                <input type="text" id="register-username" placeholder="Choose a username" maxlength="20" required>
                <span class="field-hint">Letters, numbers, underscores only</span>
            </div>

            <div class="form-group">
                <label><i class="fas fa-envelope"></i> Email Address</label>
                <input type="email" id="register-email" placeholder="Enter your email" required>
            </div>

            <div class="form-group">
                <label><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="register-password" placeholder="Create a password" required>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strength-fill"></div>
                    </div>
                    <span class="strength-text" id="strength-text">Password strength</span>
                </div>
            </div>

            <div class="form-group">
                <label><i class="fas fa-lock"></i> Confirm Password</label>
                <input type="password" id="register-confirm-password" placeholder="Confirm your password" required>
            </div>

            <div class="form-group">
                <label><i class="fas fa-venus-mars"></i> Gender (Optional)</label>
                <div class="gender-selector">
                    <label class="gender-box male">
                        <input type="radio" name="register_gender" value="male">
                        <div class="gender-content">
                            <i class="fas fa-male"></i>
                            <span>Male</span>
                        </div>
                    </label>
                    <label class="gender-box female">
                        <input type="radio" name="register_gender" value="female">
                        <div class="gender-content">
                            <i class="fas fa-female"></i>
                            <span>Female</span>
                        </div>
                    </label>
                    <label class="gender-box">
                        <input type="radio" name="register_gender" value="none" checked>
                        <div class="gender-content">
                            <i class="fas fa-question"></i>
                            <span>Prefer not to say</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="register-terms" required>
                    <span>I agree to the <a href="{{ url_for('terms_page') }}">Terms of Service</a> and <a href="{{ url_for('privacy_page') }}">Privacy Policy</a></span>
                </label>
            </div>

            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-user-plus"></i> Create Account
            </button>

            <div class="error-message" id="register-error"></div>
        </form>

        <div class="auth-footer">
            <p>Already have an account? <a href="{{ url_for('login_page') }}" class="nav-link">Sign In</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('register-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('register-username').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;
    const gender = document.querySelector('input[name="register_gender"]:checked')?.value || 'none';
    const terms = document.getElementById('register-terms').checked;
    
    if (!username || !email || !password || !confirmPassword) {
        document.getElementById('register-error').textContent = 'Please fill in all required fields';
        return;
    }
    
    if (password !== confirmPassword) {
        document.getElementById('register-error').textContent = 'Passwords do not match';
        return;
    }
    
    if (password.length < 8) {
        document.getElementById('register-error').textContent = 'Password must be at least 8 characters';
        return;
    }
    
    if (!terms) {
        document.getElementById('register-error').textContent = 'Please accept the terms';
        return;
    }
    
    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, email, password, gender })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Store JWT token and user data in localStorage
            localStorage.setItem('auth_token', data.data.token);
            localStorage.setItem('user_data', JSON.stringify(data.data.user));
            
            // Redirect to 1on1 chat page
            window.location.href = '/chat/1on1';
        } else {
            const errorMessage = data.error?.details?.[0]?.message || data.error?.message || 'Registration failed';
            document.getElementById('register-error').textContent = errorMessage;
        }
    } catch (error) {
        document.getElementById('register-error').textContent = 'An error occurred. Please try again.';
    }
});
</script>
{% endblock %}
