{% extends "base.html" %}

{% block title %}Inbox - Chat Online{% endblock %}

{% block extra_css %}
<style>
.inbox-container {
    max-width: 900px;
    margin: 0 auto;
    padding: var(--space-6);
}

.inbox-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}

.inbox-header h1 {
    font-size: var(--text-2xl);
    color: var(--bg-800);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.inbox-header h1 i {
    color: var(--primary);
}

.inbox-tabs {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
}

.inbox-tab {
    padding: var(--space-3) var(--space-6);
    background: var(--bg-100);
    border: none;
    border-radius: var(--radius-xl);
    font-weight: var(--font-semibold);
    color: var(--bg-600);
    cursor: pointer;
    transition: all var(--transition-base);
}

.inbox-tab:hover {
    background: var(--bg-200);
}

.inbox-tab.active {
    background: var(--gradient);
    color: var(--white);
}

.inbox-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.inbox-item {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--white);
    border-radius: var(--radius-xl);
    cursor: pointer;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-sm);
    border: 2px solid transparent;
}

.inbox-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary);
}

.inbox-item.unread {
    background: var(--primary-lightest);
    border-left: 4px solid var(--primary);
}

.inbox-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: relative;
}

.inbox-avatar.male {
    background: linear-gradient(135deg, #0EA5E9, #06B6D4);
}

.inbox-avatar.female {
    background: linear-gradient(135deg, #EC4899, #F472B6);
}

.inbox-avatar i {
    color: var(--white);
    font-size: var(--text-xl);
}

.inbox-content {
    flex: 1;
    min-width: 0;
}

.inbox-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-1);
}

.inbox-header h4 {
    font-size: var(--text-base);
    color: var(--bg-800);
    font-weight: var(--font-semibold);
}

.inbox-time {
    font-size: var(--text-xs);
    color: var(--bg-400);
}

.inbox-preview {
    font-size: var(--text-sm);
    color: var(--bg-500);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-badge {
    width: 24px;
    height: 24px;
    background: var(--primary);
    color: var(--white);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    flex-shrink: 0;
}

/* Message View */
.message-view {
    display: none;
    background: var(--white);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
}

.message-view.active {
    display: block;
}

.message-view-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--bg-100);
    margin-bottom: var(--space-4);
}

.message-view-header .inbox-avatar {
    width: 48px;
    height: 48px;
}

.back-btn {
    background: none;
    border: none;
    font-size: var(--text-xl);
    cursor: pointer;
    color: var(--bg-500);
    padding: var(--space-2);
}

.back-btn:hover {
    color: var(--primary);
}

.message-conversation {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: var(--space-4);
    padding: var(--space-4);
    background: var(--bg-50);
    border-radius: var(--radius-xl);
}

.message-bubble {
    max-width: 70%;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-xl);
}

.message-bubble.received {
    align-self: flex-start;
    background: var(--white);
    box-shadow: var(--shadow-sm);
}

.message-bubble.sent {
    align-self: flex-end;
    background: var(--gradient);
    color: var(--white);
}

.message-bubble p {
    margin: 0;
    font-size: var(--text-sm);
    line-height: 1.5;
}

.message-bubble .time {
    font-size: var(--text-xs);
    opacity: 0.7;
    margin-top: var(--space-1);
    display: block;
}

.message-input-area {
    display: flex;
    gap: var(--space-3);
}

.message-input-area input {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border: 2px solid var(--bg-200);
    border-radius: var(--radius-xl);
    font-size: var(--text-base);
    outline: none;
}

.message-input-area input:focus {
    border-color: var(--primary);
}

.message-input-area button {
    padding: var(--space-3) var(--space-6);
    background: var(--gradient);
    color: var(--white);
    border: none;
    border-radius: var(--radius-xl);
    font-weight: var(--font-semibold);
    cursor: pointer;
}

.message-input-area button:hover {
    transform: scale(1.05);
}

/* Empty State */
.empty-inbox {
    text-align: center;
    padding: var(--space-12);
    color: var(--bg-500);
}

.empty-inbox i {
    font-size: 64px;
    color: var(--bg-300);
    margin-bottom: var(--space-4);
}

.empty-inbox h3 {
    font-size: var(--text-xl);
    color: var(--bg-600);
    margin-bottom: var(--space-2);
}

/* Message Bubbles */
.message-bubble {
    max-width: 70%;
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-2);
}

.message-bubble.received {
    background: var(--bg-100);
    align-self: flex-start;
    border-bottom-left-radius: var(--radius-sm);
}

.message-bubble.sent {
    background: var(--gradient);
    color: var(--white);
    align-self: flex-end;
    border-bottom-right-radius: var(--radius-sm);
}

.message-bubble p {
    margin: 0;
    font-size: var(--text-sm);
}

.message-time {
    font-size: var(--text-xs);
    opacity: 0.7;
    display: block;
    margin-top: var(--space-1);
}
</style>
{% endblock %}

{% block content %}
<div class="inbox-container">
    <div class="inbox-header">
        <h1><i class="fas fa-envelope"></i> Inbox</h1>
    </div>

    <div class="inbox-tabs">
        <button class="inbox-tab active" onclick="switchTab('received')">Received</button>
        <button class="inbox-tab" onclick="switchTab('sent')">Sent</button>
    </div>

    <!-- Inbox List View -->
    <div class="inbox-list" id="inbox-list">
        <!-- Messages will be populated here -->
    </div>

    <!-- Empty State -->
    <div class="empty-inbox" id="empty-inbox" style="display: none;">
        <i class="fas fa-inbox"></i>
        <h3>No messages yet</h3>
        <p>When you receive messages, they'll show up here</p>
    </div>

    <!-- Message View -->
    <div class="message-view" id="message-view">
        <div class="message-view-header">
            <button class="back-btn" onclick="closeConversation()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="inbox-avatar" id="conversation-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div>
                <h3 id="conversation-name">User</h3>
                <span class="inbox-time" id="conversation-time"></span>
            </div>
        </div>

        <div class="message-conversation" id="message-conversation">
            <!-- Messages will be populated here -->
        </div>

        <div class="message-input-area">
            <input type="text" id="quick-message-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
            <button onclick="sendQuickMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTab = 'received';
let currentConversation = null;

// Sample data
let inboxMessages = [
    { id: 1, from: 'Sarah_99', to: 'You', gender: 'female', message: 'Hey! Want to chat more?', time: '5 min ago', read: false },
    { id: 2, from: 'John_Cool', to: 'You', gender: 'male', message: 'It was nice talking to you!', time: '1 hour ago', read: true },
    { id: 3, from: 'Emma_W', to: 'You', gender: 'female', message: 'Are you still online?', time: 'Yesterday', read: true },
    { id: 4, from: 'You', to: 'Mike_T', gender: 'male', message: 'Hi Mike! Nice to meet you!', time: 'Yesterday', read: true, sent: true },
    { id: 5, from: 'You', to: 'Lily_Rose', gender: 'female', message: 'Hey there!', time: '2 days ago', read: true, sent: true }
];

// Load messages from localStorage if any
const localMessages = JSON.parse(localStorage.getItem('inbox_messages') || '[]');
if (localMessages.length > 0) {
    inboxMessages = [...localMessages, ...inboxMessages];
}

document.addEventListener('DOMContentLoaded', function() {
    renderMessages();
});

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.inbox-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    renderMessages();
}

function renderMessages() {
    const list = document.getElementById('inbox-list');
    const empty = document.getElementById('empty-inbox');

    let messages;
    if (currentTab === 'received') {
        messages = inboxMessages.filter(m => !m.sent && m.to === 'You');
    } else {
        messages = inboxMessages.filter(m => m.sent || m.from === 'You');
    }

    if (messages.length === 0) {
        list.innerHTML = '';
        empty.style.display = 'block';
        empty.querySelector('h3').textContent = currentTab === 'received' ? 'No received messages' : 'No sent messages';
        empty.querySelector('p').textContent = currentTab === 'received' ? 'When you receive messages, they\'ll show up here' : 'Messages you send will appear here';
        return;
    }

    empty.style.display = 'none';
    list.innerHTML = '';

    messages.forEach(msg => {
        const isReceived = currentTab === 'received';
        const sender = isReceived ? msg.from : msg.to;
        const gender = msg.gender || 'male';

        const item = document.createElement('div');
        item.className = 'inbox-item' + (msg.read ? '' : ' unread');
        item.onclick = () => openConversation(msg);
        item.innerHTML = `
            <div class="inbox-avatar ${gender}">
                <i class="fas fa-user"></i>
            </div>
            <div class="inbox-content">
                <div class="inbox-header-row">
                    <h4>${sender}</h4>
                    <span class="inbox-time">${msg.time}</span>
                </div>
                <p class="inbox-preview">${msg.message}</p>
            </div>
            ${!msg.read && isReceived ? '<span class="unread-badge">1</span>' : ''}
        `;
        list.appendChild(item);
    });
}

function openConversation(msg) {
    // Mark as read
    msg.read = true;
    currentConversation = msg;

    // Show message view, hide list and empty
    document.getElementById('inbox-list').style.display = 'none';
    document.getElementById('empty-inbox').style.display = 'none';
    document.getElementById('message-view').classList.add('active');

    // Update header
    document.getElementById('conversation-name').textContent = msg.from;
    document.getElementById('conversation-time').textContent = msg.time;

    // Update avatar
    const avatar = document.getElementById('conversation-avatar');
    avatar.className = 'inbox-avatar ' + (msg.gender || 'male');

    renderMessages();
    renderConversation();
}

function closeConversation() {
    currentConversation = null;
    document.getElementById('message-view').classList.remove('active');
    document.getElementById('inbox-list').style.display = 'block';

    const messages = inboxMessages.filter(m => !m.sent && m.to === 'You');
    if (messages.length === 0) {
        document.getElementById('empty-inbox').style.display = 'block';
    }
}

function renderConversation() {
    const conv = document.getElementById('message-conversation');
    if (!currentConversation) return;

    // Filter messages for this conversation
    const otherUser = currentConversation.from;
    const messages = inboxMessages.filter(m =>
        (m.from === otherUser && m.to === 'You') ||
        (m.from === 'You' && m.to === otherUser)
    ).reverse();

    conv.innerHTML = messages.map(msg => {
        const isSent = msg.sent || msg.from === 'You';
        return `
            <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                <p>${msg.message}</p>
                <span class="message-time">${msg.time}</span>
            </div>
        `;
    }).join('');
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        sendQuickMessage();
    }
}

function sendQuickMessage() {
    const input = document.getElementById('quick-message-input');
    const message = input.value.trim();

    if (!message || !currentConversation) return;

    const newMsg = {
        id: Date.now(),
        from: 'You',
        to: currentConversation.from,
        gender: 'male',
        message: message,
        time: 'Just now',
        read: true,
        sent: true
    };

    inboxMessages.unshift(newMsg);
    localStorage.setItem('inbox_messages', JSON.stringify(inboxMessages));

    input.value = '';
    renderMessages();
}
</script>
{% endblock %}
