{% extends "base.html" %}

{% block title %}Login - Chat Online{% endblock %}

{% block content %}
<div class="auth-page-container">
    <div class="auth-card login-card">
        <div class="auth-header">
            <div class="logo-section">
                <i class="fas fa-comments"></i>
            </div>
            <h1>Welcome Back</h1>
            <p>Login to your account</p>
        </div>

        <!-- Step 1: Email -->
        <div id="login-step-email" class="login-step">
            <form id="login-email-form" class="auth-form-full">
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    Continue <i class="fas fa-arrow-right"></i>
                </button>
            </form>
            <div class="error-message" id="login-email-error"></div>
        </div>

        <!-- Step 2: Password -->
        <div id="login-step-password" class="login-step hidden">
            <form id="login-password-form" class="auth-form-full">
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button type="button" class="btn btn-secondary btn-block" id="login-back-btn">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <a href="#" class="forgot-password">Forgot Password?</a>
            </form>
            <div class="error-message" id="login-password-error"></div>
        </div>

        <div class="auth-footer">
            <p>Don't have an account? <a href="{{ url_for('register_page') }}" class="nav-link">Sign Up</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let userEmail = '';

document.getElementById('login-email-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    userEmail = document.getElementById('login-email').value.trim();
    
    if (!userEmail) {
        document.getElementById('login-email-error').textContent = 'Please enter your email';
        return;
    }
    
    // Show password step
    document.getElementById('login-step-email').classList.add('hidden');
    document.getElementById('login-step-password').classList.remove('hidden');
});

document.getElementById('login-password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const password = document.getElementById('login-password').value;
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usernameOrEmail: userEmail, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Store JWT token and user data in localStorage
            localStorage.setItem('auth_token', data.data.token);
            localStorage.setItem('user_data', JSON.stringify(data.data.user));
            
            // Redirect to chat page
            window.location.href = '/chat/1on1';
        } else {
            document.getElementById('login-password-error').textContent = data.error?.message || 'Login failed';
        }
    } catch (error) {
        document.getElementById('login-password-error').textContent = 'An error occurred. Please try again.';
    }
});

document.getElementById('login-back-btn').addEventListener('click', function() {
    document.getElementById('login-step-password').classList.add('hidden');
    document.getElementById('login-step-email').classList.remove('hidden');
    document.getElementById('login-password').value = '';
    document.getElementById('login-password-error').textContent = '';
});
</script>
{% endblock %}
